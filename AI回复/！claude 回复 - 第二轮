# ğŸ¯ å…·ä½“å®æ–½æ–¹æ¡ˆï¼šReact + PyQt6 æ··åˆæ¶æ„è½åœ°ä»£ç 

æˆ‘å®Œå…¨ç†è§£ä½ çš„éœ€æ±‚ã€‚ä¸‹é¢æ˜¯**å¯ç›´æ¥è¿è¡Œ**çš„ä»£ç ï¼Œé’ˆå¯¹ä½ ç°æœ‰çš„ `LoginManager` å’Œ React ç»„ä»¶ã€‚

---

## 1ï¸âƒ£ Web ä¾§ï¼šReact Hook æ¡¥æ¥ï¼ˆå®Œæ•´å¯ç”¨ä»£ç ï¼‰---

## 2ï¸âƒ£ Python ä¾§ï¼šWebChannel + Bridge ç±»ï¼ˆç›´æ¥æ›¿æ¢ä½ çš„ä»£ç ï¼‰---

## 3ï¸âƒ£ æ„å»ºå·¥ä½œæµï¼šä» React åˆ° `.exe`ï¼ˆå®Œæ•´æµç¨‹ï¼‰---

## ğŸ¯ å¿«é€Ÿé›†æˆæ¸…å•ï¼ˆç›´æ¥è¡ŒåŠ¨æŒ‡å—ï¼‰

### ğŸ“‹ æ­¥éª¤ 1ï¼šä¿®æ”¹ä½ çš„ React ç»„ä»¶ï¼ˆ5åˆ†é’Ÿï¼‰

```bash
cd web/src
# åˆ›å»º hooks ç›®å½•
mkdir hooks
# å¤åˆ¶æˆ‘æä¾›çš„ usePyQtBridge.tsx åˆ° hooks/
```

ä¿®æ”¹ä½ çš„ `openwrt-manager.tsx`ï¼š

```tsx
// åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
import { usePyQtBridge } from './hooks/usePyQtBridge'

export default function OpenWrtManager() {
  // ğŸ”¥ æ›¿æ¢åŸæœ‰çš„çŠ¶æ€ç®¡ç†
  const { 
    isConnected, 
    isScanning, 
    results, 
    startDetection, 
    stopDetection 
  } = usePyQtBridge()
  
  const [targets, setTargets] = useState("")

  const handleStartScan = () => {
    if (!targets.trim()) return
    startDetection(targets)  // ğŸ”¥ è°ƒç”¨ Python
  }

  // å…¶ä½™ä»£ç ä¿æŒä¸å˜ï¼Œç›´æ¥ä½¿ç”¨ results
  return (
    <div>
      {/* è¿æ¥æŒ‡ç¤ºå™¨ */}
      {!isConnected && (
        <div className="fixed top-0 left-0 right-0 bg-yellow-100 p-2 text-center">
          âš ï¸ æ­£åœ¨è¿æ¥ Python åç«¯...
        </div>
      )}
      
      {/* åŸæœ‰çš„ UI ä»£ç  */}
      <button onClick={isScanning ? stopDetection : handleStartScan}>
        {isScanning ? 'åœæ­¢' : 'å¼€å§‹æ¢æµ‹'}
      </button>
      
      {/* è¡¨æ ¼ç›´æ¥ä½¿ç”¨ results */}
      <table>
        {results.map(result => (
          <tr key={result.id}>
            <td>{result.address}</td>
            <td>{result.status}</td>
          </tr>
        ))}
      </table>
    </div>
  )
}
```

### ğŸ“‹ æ­¥éª¤ 2ï¼šé…ç½®å‰ç«¯æ„å»ºï¼ˆ3åˆ†é’Ÿï¼‰

```bash
cd web
npm install  # å¦‚æœè¿˜æ²¡å®‰è£…ä¾èµ–

# åˆ›å»º vite.config.tsï¼ˆå¤åˆ¶æˆ‘æä¾›çš„é…ç½®ï¼‰
# åˆ›å»º scripts/post-build.jsï¼ˆå¤åˆ¶æˆ‘æä¾›çš„è„šæœ¬ï¼‰

# æ·»åŠ  package.json è„šæœ¬
npm pkg set scripts.build="vite build && node scripts/post-build.js"
```

### ğŸ“‹ æ­¥éª¤ 3ï¼šä¿®æ”¹ Python ä»£ç ï¼ˆ10åˆ†é’Ÿï¼‰

**åˆ›å»ºæ–°æ–‡ä»¶ `webengine_bridge.py`**ï¼ˆå¤åˆ¶æˆ‘æä¾›çš„å®Œæ•´ä»£ç ï¼‰

**ä¿®æ”¹ `openwrt_manager.py`**ï¼š

```python
# åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
from webengine_bridge import PyQtBridge, WebBridge
from PyQt6.QtWebEngineWidgets import QWebEngineView
from PyQt6.QtWebChannel import QWebChannel

# ä¿®æ”¹ MainWindow.__init__
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # ğŸ”¥ æ›¿æ¢åŸæœ‰çš„ UI åˆ›å»º
        self.setup_webengine()
        
        # å…¶ä½™åˆå§‹åŒ–ä¿æŒä¸å˜
        self.connect_signals()
    
    def setup_webengine(self):
        """è®¾ç½® WebEngine"""
        # WebEngineView
        self.webview = QWebEngineView()
        self.setCentralWidget(self.webview)
        
        # QWebChannel
        self.channel = QWebChannel()
        self.py_bridge = PyQtBridge(self)
        self.channel.registerObject('bridge', self.py_bridge)
        self.webview.page().setWebChannel(self.channel)
        
        # Web Bridge
        self.web_bridge = WebBridge(self.webview)
        
        # åŠ è½½é¡µé¢
        html_path = Path(__file__).parent / 'web' / 'dist' / 'index.html'
        self.webview.setUrl(QUrl.fromLocalFile(str(html_path.absolute())))
        
        # è°ƒè¯•
        self.webview.loadFinished.connect(
            lambda ok: print("âœ… é¡µé¢åŠ è½½" if ok else "âŒ åŠ è½½å¤±è´¥")
        )

# ä¿®æ”¹ LoginManagerï¼Œä¼ å…¥ web_bridge
self.login_manager = LoginManager(
    max_concurrent=50, 
    web_bridge=self.web_bridge
)
```

**ä¿®æ”¹ `LoginManager.detect_login`**ï¼ˆæ·»åŠ  Web å›è°ƒï¼‰ï¼š

```python
async def detect_login(self, row: int, target_url: str):
    # ... åŸæœ‰æ£€æµ‹é€»è¾‘ ...
    
    # ğŸ”¥ æ·»åŠ  Web å›è°ƒï¼ˆåœ¨æ›´æ–°çŠ¶æ€æ—¶ï¼‰
    if self.web_bridge:
        self.web_bridge.call_js_callback(
            'onUpdateRow',
            row,
            status,      # "ç™»å½•æˆåŠŸ" / "ç™»å½•å¤±è´¥"
            username,
            password,
            notes
        )
    
    # ä¿ç•™åŸæœ‰çš„ä¿¡å·ï¼ˆå…¼å®¹æ€§ï¼‰
    self.signal_bridge.update_row.emit(row, status, username, password, notes)
```

### ğŸ“‹ æ­¥éª¤ 4ï¼šæµ‹è¯•è¿è¡Œï¼ˆ2åˆ†é’Ÿï¼‰

```bash
# æ„å»ºå‰ç«¯
cd web
npm run build

# è¿è¡Œ Python
cd ..
python openwrt_manager.py
```

**é¢„æœŸæ•ˆæœï¼š**
- çª—å£æ‰“å¼€ï¼Œæ˜¾ç¤ºä½ çš„ v0 è®¾è®¡
- ç‚¹å‡»"å¼€å§‹æ¢æµ‹"ï¼Œè¡¨æ ¼å®æ—¶æ›´æ–°
- F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
  ```
  ğŸ”· PyQt WebEngine ç¯å¢ƒå·²å°±ç»ª
  âœ… QWebChannel è¿æ¥æˆåŠŸ
  ğŸ“¥ æ”¶åˆ°ä¿¡å·: row=0, status=ç™»å½•æˆåŠŸ
  ```

---

## ğŸ”¥ å¸¸è§é—®é¢˜é€ŸæŸ¥

### Q1: é¡µé¢ç©ºç™½ï¼Ÿ

```python
# æ£€æŸ¥è·¯å¾„
html_path = Path(__file__).parent / 'web' / 'dist' / 'index.html'
print(f"åŠ è½½è·¯å¾„: {html_path}")
print(f"æ–‡ä»¶å­˜åœ¨: {html_path.exists()}")

# ä¸´æ—¶è§£å†³ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„
self.webview.setUrl(QUrl.fromLocalFile(str(html_path.resolve())))
```

### Q2: QWebChannel è¿æ¥å¤±è´¥ï¼Ÿ

```javascript
// åœ¨ React ä¸­æ·»åŠ è°ƒè¯•
useEffect(() => {
  console.log('æ£€æŸ¥ qt å¯¹è±¡:', typeof window.qt)
  console.log('æ£€æŸ¥ QWebChannel:', typeof QWebChannel)
}, [])
```

### Q3: Python ä¿¡å·æ²¡ååº”ï¼Ÿ

```python
# åœ¨ Python ä¸­éªŒè¯
self.web_bridge.call_js_callback('onUpdateRow', 0, 'test', '', '', '')

# ç„¶ååœ¨æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥æ˜¯å¦æœ‰è¾“å‡º
```

### Q4: æ‰“åŒ…åæ— æ³•è¿è¡Œï¼Ÿ

```python
# æ”¹ç”¨ qrc èµ„æº
# 1. åˆ›å»º resources.qrc
# 2. pyrcc6 resources.qrc -o resources_rc.py
# 3. åœ¨ä»£ç ä¸­ import resources_rc
# 4. ä½¿ç”¨ QUrl("qrc:/index.html")
```

---

## ğŸ’¡ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ React.memo å‡å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“
   - æ‰¹é‡æ›´æ–° resultsï¼ˆä¸è¦æ¯è¡Œéƒ½è§¦å‘ä¸€æ¬¡ï¼‰

2. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - æ·»åŠ åŠ è½½åŠ¨ç”»
   - æ·»åŠ é”™è¯¯è¾¹ç•Œå¤„ç†
   - å®ç°æ–­çº¿é‡è¿

3. **è°ƒè¯•å·¥å…·**ï¼š
   - ä¿ç•™å¼€å‘è€…å·¥å…·å¼€å…³
   - æ·»åŠ æ—¥å¿—å¯¼å‡ºåŠŸèƒ½

---

éœ€è¦æˆ‘é’ˆå¯¹æŸä¸ªå…·ä½“æ­¥éª¤æä¾›æ›´è¯¦ç»†çš„ä»£ç å—ï¼Ÿæ¯”å¦‚ï¼š
- å®Œæ•´çš„ `webengine_bridge.py` æ–‡ä»¶
- ä¿®æ”¹åçš„å®Œæ•´ `MainWindow` ç±»
- æ‰“åŒ…è„šæœ¬çš„å®Œæ•´ç‰ˆæœ¬

æˆ‘å¯ä»¥æ ¹æ®ä½ çš„å…·ä½“éœ€æ±‚è¿›ä¸€æ­¥ç»†åŒ–ï¼ğŸš€