# OpenWrt 多版本兼容更新日志

## v1.2 (2025-12-30) - 多版本兼容性增强

### 🎯 更新目标

支持多种 OpenWrt 硬件和软件变体，包括但不限于：
- 标准 OpenWrt (LuCI)
- iStoreOS
- PandoraBox
- PandoraBox DEC2
- 其他基于 LuCI 的定制版本

---

### ✨ 新功能

#### 1. 多登录路径支持

程序现在会自动尝试以下登录路径（按优先级）：

```python
LOGIN_PATHS = [
    "/cgi-bin/luci",           # 标准 LuCI (优先)
    "/cgi-bin/luci/admin",     # 部分定制版本
    "/login",                  # 简化路径
]
```

**工作原理**：
- 依次尝试每个路径
- 发现有效路径后，继续在该路径上尝试凭证
- 全部失败后再尝试下一个路径

#### 2. 多字段名变体支持

程序现在支持不同的表单字段名：

```python
FIELD_NAME_VARIANTS = [
    {"username": "luci_username", "password": "luci_password"},  # 标准 LuCI
    {"username": "username", "password": "password"},            # 简化版 (PandoraBox等)
    {"username": "auth_username", "password": "auth_password"},  # 认证版
]
```

**工作原理**：
- 对每个凭证，尝试不同的字段名组合
- 收到非404/500响应后，认为字段名正确，停止尝试其他变体
- 继续使用正确的字段名测试下一个凭证

#### 3. 智能探测逻辑

```
for 每个登录路径:
    ├─ 访问页面初始化 Session
    ├─ for 每个凭证:
    │   └─ for 每个字段名变体:
    │       ├─ 发送登录请求
    │       ├─ 检查是否成功
    │       └─ 成功 → 立即返回 ✅
    └─ 所有失败 → 尝试下一个路径
```

---

### 🔧 技术改进

#### 超时时间调整

```python
# 从 8 秒增加到 10 秒
timeout = aiohttp.ClientTimeout(total=10)
```

**原因**：支持更多路径和字段名组合，需要更多时间

#### 备注信息增强

成功登录后，备注会显示：
```
/cgi-bin/luci | luci_username
```

分别表示：
- 使用的登录路径
- 使用的字段名

这有助于分析不同设备的配置情况。

---

### 📊 兼容性对比

| OpenWrt 版本 | v1.0/1.1 | v1.2 |
|--------------|----------|------|
| 标准 LuCI | ✅ | ✅ |
| iStoreOS | ✅ | ✅ |
| PandoraBox (标准字段) | ✅ | ✅ |
| PandoraBox (简化字段) | ❌ | ✅ |
| 非标准路径设备 | ❌ | ✅ |

---

### ⚡ 性能影响

#### 最坏情况分析

**v1.1**：
- 路径: 1 个固定路径
- 字段名: 1 种固定组合
- 凭证: 5 个
- **总请求数**: 5 次/设备

**v1.2**：
- 路径: 最多 3 个
- 字段名: 最多 3 种
- 凭证: 5 个
- **最坏情况**: 3 × 3 × 5 = 45 次/设备

#### 实际优化

**智能提前退出**：
1. ✅ 找到正确路径后，不再尝试其他路径
2. ✅ 找到正确字段名后，不再尝试其他变体
3. ✅ 登录成功后，立即停止所有尝试

**实际请求数** (典型场景)：
- **成功设备**: 5-10 次（快速找到正确配置）
- **失败设备**: 15-25 次（尝试所有凭证，但只用1-2种配置）
- **无法连接**: 1-3 次（第一个路径失败即停止）

**预计性能**：
- 成功设备：速度几乎不变 ⚡
- 失败设备：增加 2-3 秒 ⏱️
- 整体：可接受的性能损失，换来大幅提升兼容性

---

### 📝 使用说明

#### 无需额外配置

程序会**自动尝试**所有路径和字段名组合，用户无需做任何修改。

#### 自定义配置（可选）

如果您知道设备使用特定路径或字段名，可以修改代码：

```python
# 文件开头的配置
LOGIN_PATHS = [
    "/your/custom/path",  # 添加您的路径
    "/cgi-bin/luci",
]

FIELD_NAME_VARIANTS = [
    {"username": "custom_user", "password": "custom_pass"},  # 自定义字段名
    {"username": "luci_username", "password": "luci_password"},
]
```

#### 诊断工具

新增 `diagnose_login.py` 工具，用于诊断单个设备：

```bash
python diagnose_login.py
# 输入设备地址，自动检测路径和字段名
```

---

### 🐛 已知限制

1. **CSRF Token**: 暂不支持强制 Token 的新版 LuCI
2. **客户端证书**: 不支持需要客户端证书的认证
3. **OAuth/SSO**: 不支持第三方登录

---

### 🔮 后续计划

1. ✅ 多路径支持 (v1.2 完成)
2. ✅ 多字段名支持 (v1.2 完成)
3. ⬜ CSRF Token 自动提取 (v1.3 计划)
4. ⬜ 智能 HTML 解析 (v1.4 计划)
5. ⬜ SSH 登录支持 (v2.0 计划)

---

### 💡 升级建议

**立即升级**，如果：
- ✅ 您有 PandoraBox 设备
- ✅ 您有定制版 OpenWrt
- ✅ 之前测试成功率低于预期

**可以等待**，如果：
- ⏸️ 所有设备都是标准 OpenWrt
- ⏸️ 当前版本工作正常

---

## 测试建议

1. **小规模测试**: 先测试 10-20 个设备
2. **对比结果**: 与 v1.1 的成功率对比
3. **查看备注**: 检查成功设备使用的路径和字段名
4. **大规模部署**: 确认兼容性后批量测试

---

**版本**: v1.2  
**发布日期**: 2025-12-30  
**测试状态**: ✅ 已测试，建议升级
